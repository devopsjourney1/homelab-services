version: '3'
services:
  tailscale:
    container_name: tailscaled
    hostname: tailscaled
    volumes:
        - tailscale:/var/lib/tailscale
        - /dev/net/tun:/dev/net/tun
    network_mode: host
    environment:
        - TS_ROUTES=$SUBNET
        - TS_STATE=/var/lib/tailscale/tailscaled.state
        - TS_STATE_DIR=/var/lib/tailscale/
    image: tailscale/tailscale:stable
    restart: unless-stopped
  uptime-kuma:
    container_name: kuma
    image: louislam/uptime-kuma:1
    hostname: kuma
    restart: unless-stopped
    labels:
      traefik.enable: "true"
      traefik.http.services.kuma.loadbalancer.server.port: "3001"
      traefik.http.routers.kuma-http.entrypoints: "web"
      traefik.http.routers.kuma-http.rule: "Host(`kuma.devopsbrad.com`)"
      traefik.http.routers.kuma-https.entrypoints: "websecure"
      traefik.http.routers.kuma-https.rule: "Host(`kuma.devopsbrad.com`)"
      traefik.http.routers.kuma-https.tls: "true"
      traefik.http.routers.kuma-https.tls.certresolver: "letsEncrypt-production"
    volumes:
      - kuma-storage:/app/data
    network_mode: host
    deploy:
      resources:
        limits:
          memory: 256M

volumes:
  tailscale:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '$VOLUME_PATH/tailscale'
  kuma-storage:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '$VOLUME_PATH/kuma'